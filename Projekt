import sys
from PyQt5.QtWidgets import QApplication, QWidget, QPushButton, QHBoxLayout, QVBoxLayout, QLabel
from PyQt5.QtCore import Qt, QTimer, QPointF
from PyQt5.QtGui import QPainter, QColor, QPen, QPainterPath


class Rura:
    def __init__(self, punkty, grubosc=12, kolor=Qt.gray):
        self.punkty = [QPointF(float(p[0]), float(p[1])) for p in punkty]
        self.grubosc = grubosc
        self.kolor_rury = kolor
        self.kolor_cieczy = QColor(0, 180, 255)
        self.czy_plynie = False

    def draw(self, painter):
        if len(self.punkty) < 2:
            return

        path = QPainterPath()
        path.moveTo(self.punkty[0])
        for p in self.punkty[1:]:
            path.lineTo(p)

        pen_rura = QPen(self.kolor_rury, self.grubosc, Qt.SolidLine, Qt.RoundCap, Qt.RoundJoin)
        painter.setPen(pen_rura)
        painter.setBrush(Qt.NoBrush)
        painter.drawPath(path)

        if self.czy_plynie:
            pen_ciecz = QPen(self.kolor_cieczy, self.grubosc - 4, Qt.SolidLine, Qt.RoundCap, Qt.RoundJoin)
            painter.setPen(pen_ciecz)
            painter.drawPath(path)

    def ustaw_przeplyw(self, plynie):
        self.czy_plynie = plynie


class Zbiornik:
    def __init__(self, x, y, width=100, height=140, nazwa=""):
        self.x = x
        self.y = y
        self.width = width
        self.height = height
        self.nazwa = nazwa

        self.pojemnosc = 100.0
        self.aktualna_ilosc = 0.0
        self.poziom = 0.0

    def dodaj_ciecz(self, ilosc):
        wolne = self.pojemnosc - self.aktualna_ilosc
        dodano = min(ilosc, wolne)
        self.aktualna_ilosc += dodano
        self.aktualizuj_poziom()
        return dodano

    def usun_ciecz(self, ilosc):
        usunieto = min(ilosc, self.aktualna_ilosc)
        self.aktualna_ilosc -= usunieto
        self.aktualizuj_poziom()
        return usunieto

    def aktualizuj_poziom(self):
        self.poziom = self.aktualna_ilosc / self.pojemnosc

    def czy_pusty(self):
        return self.aktualna_ilosc <= 0.1

    def czy_pelny(self):
        return self.aktualna_ilosc >= self.pojemnosc

    def punkt_gora_srodek(self):
        return (self.x + self.width / 2, self.y)

    def punkt_dol_srodek(self):
        return (self.x + self.width / 2, self.y + self.height)

    def draw(self, painter):
        if self.poziom > 0:
            h_cieczy = self.height * self.poziom
            y_start = self.y + self.height - h_cieczy
            painter.setPen(Qt.NoPen)
            painter.setBrush(QColor(0, 120, 255, 200))
            painter.drawRect(int(self.x + 3), int(y_start),
                             int(self.width - 6), int(h_cieczy))

        pen = QPen(Qt.white, 4)
        painter.setPen(pen)
        painter.setBrush(Qt.NoBrush)
        painter.drawRect(int(self.x), int(self.y),
                          int(self.width), int(self.height))

        painter.setPen(Qt.white)
        painter.drawText(int(self.x), int(self.y - 10), self.nazwa)

class SymulacjaKaskady(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Kaskada: Góra -> Dół z alarmami")
        self.setFixedSize(1100, 750)
        self.setStyleSheet("background-color: #222;")

        self.z1 = Zbiornik(20, 20, nazwa="Zbiornik 1")
        self.z1.aktualna_ilosc = 100.0
        self.z1.aktualizuj_poziom()

        self.z2 = Zbiornik(300, 180, nazwa="Zbiornik 2")
        self.z3 = Zbiornik(600, 340, nazwa="Zbiornik 3")
        self.z4 = Zbiornik(900, 500, nazwa="Zbiornik 4")
        self.zbiorniki = [self.z1, self.z2, self.z3, self.z4]

        p1s = self.z1.punkt_dol_srodek()
        p1k = self.z2.punkt_gora_srodek()
        m1 = (p1s[1] + p1k[1]) / 2
        self.rura1 = Rura([p1s, (p1s[0], m1), (p1k[0], m1), p1k])

        p2s = self.z2.punkt_dol_srodek()
        p2k = self.z3.punkt_gora_srodek()
        m2 = (p2s[1] + p2k[1]) / 2
        self.rura2 = Rura([p2s, (p2s[0], m2), (p2k[0], m2), p2k])

        p3s = self.z3.punkt_dol_srodek()
        p3k = self.z4.punkt_gora_srodek()
        m3 = (p3s[1] + p3k[1]) / 2
        self.rura3 = Rura([p3s, (p3s[0], m3), (p3k[0], m3), p3k])

        self.rury = [self.rura1, self.rura2, self.rura3]

        self.alarmy = []

        self.timer = QTimer()
        self.timer.timeout.connect(self.logika_przeplywu)
        self.running = False
        self.flow_speed = 0.8

        self.btn_start = QPushButton("Start/Stop", self)
        self.btn_start.setGeometry(50, 650, 100, 30)
        self.btn_start.clicked.connect(self.przelacz_symulacje)

        container = QWidget(self)
        container.setGeometry(170, 600, 700, 100)
        layout = QHBoxLayout(container)

        for zb in self.zbiorniki:
            v = QVBoxLayout()
            lbl = QLabel(zb.nazwa)
            lbl.setStyleSheet("color:white;")
            lbl.setAlignment(Qt.AlignCenter)

            btn_f = QPushButton("[+] Napełnij")
            btn_f.clicked.connect(lambda _, z=zb: self.reczne_napelnianie(z))
            btn_e = QPushButton("[-] Opróżnij")
            btn_e.clicked.connect(lambda _, z=zb: self.reczne_oproznianie(z))

            v.addWidget(lbl)
            v.addWidget(btn_f)
            v.addWidget(btn_e)
            layout.addLayout(v)

    def reczne_napelnianie(self, zb):
        zb.aktualna_ilosc = zb.pojemnosc
        zb.aktualizuj_poziom()
        self.update()

    def reczne_oproznianie(self, zb):
        zb.aktualna_ilosc = 0
        zb.aktualizuj_poziom()
        self.update()

    def przelacz_symulacje(self):
        if self.running:
            self.timer.stop()
        else:
            self.timer.start(20)
        self.running = not self.running

    def logika_przeplywu(self):
        # Z1 -> Z2 (do poziomu 35)
        plynie_1 = False
        if not self.z1.czy_pusty() and self.z2.aktualna_ilosc < 35:
            ilosc = self.z1.usun_ciecz(self.flow_speed)
            self.z2.dodaj_ciecz(ilosc)
            plynie_1 = True
        self.rura1.ustaw_przeplyw(plynie_1)

        plynie_2 = False
        if self.z2.aktualna_ilosc >= 35 and not self.z3.czy_pelny():
            ilosc = self.z2.usun_ciecz(self.flow_speed)
            self.z3.dodaj_ciecz(ilosc)
            plynie_2 = True
        self.rura2.ustaw_przeplyw(plynie_2)

        plynie_3 = False
        if self.z3.aktualna_ilosc >= 35 and not self.z4.czy_pelny():
            ilosc = self.z3.usun_ciecz(self.flow_speed)
            self.z4.dodaj_ciecz(ilosc)
            plynie_3 = True
        self.rura3.ustaw_przeplyw(plynie_3)

        self.alarmy.clear()
        for zb in self.zbiorniki:
            if zb.czy_pelny():
                self.alarmy.append(f"{zb.nazwa} jest pełny!")

        self.update()

    def paintEvent(self, event):
        p = QPainter(self)
        p.setRenderHint(QPainter.Antialiasing)
        for r in self.rury:
            r.draw(p)
        for z in self.zbiorniki:
            z.draw(p)

        p.setPen(QColor(255, 0, 0))
        for i, alarm in enumerate(self.alarmy):
            p.drawText(800, 30 + i*20, alarm)

if __name__ == "__main__":
    app = QApplication(sys.argv)
    w = SymulacjaKaskady()
    w.show()
    sys.exit(app.exec())
